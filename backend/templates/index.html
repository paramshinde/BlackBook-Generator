<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project Document Editor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='app.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}" />
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }

        .main-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px;
        }

        .container {
            display: flex;
            width: 100%;
            max-width: 1200px;
            background: #fff;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            gap: 40px;
        }

        h1 {
            color: #4caf50;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-section,
        .preview-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .details-section {
            background-color: #e9e9e9;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .details-section p {
            margin: 5px 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="file"],
        select,
        textarea { /* ADDED TEXTAREA */
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        button {
            background-color: #4caf50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover:not(:disabled) {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }

        #toggle-preview-btn {
            background-color: #6c757d;
        }

        #toggle-preview-btn:hover:not(:disabled) {
            background-color: #5a6268;
        }

        #generate-btn {
            background-color: #3f51b5;
        }

        #generate-btn:hover:not(:disabled) {
            background-color: #303f9f;
        }

        .preview-content {
            white-space: pre-wrap;
            border: 1px solid #ccc;
            padding: 15px;
            background-color: #fafafa;
            border-radius: 6px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .hidden {
            display: none;
        }

        .diagram-manager {
            margin-top: 30px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }

        .diagram-card {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 14px;
            margin-bottom: 14px;
            background: #fafafa;
        }

        .diagram-card h4 {
            margin: 0 0 10px;
        }

        .diagram-row {
            display: grid;
            grid-template-columns: 1fr 220px;
            gap: 12px;
            align-items: end;
        }

        .diagram-row button {
            margin-bottom: 20px;
            background-color: #303f9f;
        }

        .diagram-status {
            font-size: 0.9em;
            margin-top: -8px;
            margin-bottom: 10px;
            min-height: 18px;
        }

        .diagram-preview {
            max-width: 100%;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #fff;
            padding: 4px;
        }

        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #ddd;
            border-top-color: #303f9f;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
            margin-right: 6px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .diagram-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="main-wrapper">
        <h1>ðŸ“„ Project Document Update Tool</h1>

        <div class="container">
            <div class="form-section">
                <label for="template_selector">Select Template:</label>
                <select id="template_selector" name="template_file">
                    {% for config in template_configs %}
                    <option value="{{ config.file }}" data-details='{{ config.old_details | tojson }}'>
                        {{ config.name }}
                    </option>
                    {% endfor %}
                </select>

                <div class="details-section">
                    <h2>Current Template Details</h2>
                    <p>
                        <strong>File:</strong>
                        <span id="current_file_span">{{ default_template_file }}</span>
                    </p>
                    <p>
                        <strong>Student Name:</strong>
                        <span id="old_name_span">{{ old_details['student_name'] }}</span>
                    </p>
                    <p>
                        <strong>Project Title:</strong>
                        <span id="old_project_span">{{ old_details['project_title'] }}</span>
                    </p>
                    <p>
                        <strong>Professor Name:</strong>
                        <span id="old_professor_span">{{ old_details['professor_name'] }}</span>
                    </p>
                    <p>
                        <strong>Guide Name:</strong>
                        <span id="old_guide_span">{{ old_details['guide_name'] }}</span>
                    </p>
                    <p>
                        <strong>Year:</strong>
                        <span id="old_year_span">{{ old_details['year'] }}</span>
                    </p>
                </div>

                <h2>Enter New Details</h2>
                <form id="mainForm" action="/upload_and_update" method="post" enctype="multipart/form-data">
                    <input type="hidden" id="generated_files_data" name="generated_files_data" value="" />
                    <input type="hidden" id="selected_template_file" name="template_file"
                        value="{{ default_template_file }}" />

                    <label for="student_name">New Student Name:</label>
                    <input type="text" id="student_name" name="student_name" placeholder="Leave blank to keep current" />

                    <label for="project_title">New Project Title:</label>
                    <input type="text" id="project_title" name="project_title" placeholder="Leave blank to keep current" />

                    <label for="professor_name">New Professor Name:</label>
                    <input type="text" id="professor_name" name="professor_name" placeholder="Leave blank to keep current" />

                    <label for="guide_name">New Guide Name:</label>
                    <input type="text" id="guide_name" name="guide_name" placeholder="Leave blank to keep current" />

                    <label for="year">New Year (e.g., 2025-2026):</label>
                    <input type="text" id="year" name="year" value="{{ default_new_year }}" />

                    <h2 style="margin-top: 30px">ðŸ“„ Document Content Editor</h2>

                    <label for="doc_section_selector">Select Document Section to Edit:</label>
                    <select id="doc_section_selector" name="doc_section_selector" style="margin-bottom: 20px">
                        <option value="doc_introduction" selected>1. Introduction</option>
                        <option value="doc_objective">2. Objective</option>
                        <option value="doc_scope">3. Scope of Project</option>
                        <option value="doc_techstack">4. Technology Stack</option>
                        <option value="doc_feasibility">5. Feasibility Study</option>
                        <option value="doc_system_features">6. System Features</option>
                        <option value="doc_modules">7. Modules</option>
                        <option value="doc_usecase">8. Use Case</option>
                        <option value="doc_advantage">9. Advantage</option>
                        <option value="doc_hardware_req">10. Hardware Requirements</option>
                        <option value="doc_software_req">11. Software Requirements</option>
                    </select>

                    <button type="button" id="generate-doc-btn" class="btn btn-primary my-2" style="background-color: #28a745; margin-bottom: 10px;">
                        ðŸš€ Generate Documentation with AI
                    </button>
                    <div id="ai-status" class="form-text" style="margin-bottom: 20px; font-size: 0.9em;"></div>
                    <label for="content_editor">Content for Section:</label>
                    <textarea id="content_editor" name="doc_introduction" rows="10"
                        placeholder="Paste or edit the content for this section here."></textarea>
                    <p style="font-size: 0.8em; color: #666; margin-top: -10px">
                        This text will replace the tag [[doc_introduction]] in the template.
                    </p>
                    
                    <h2 style="margin-top: 30px;">ðŸ’» Code Implementation</h2>
                    
                    <div id="code_files_container">
                        <div class="code-entry" data-index="1">
                            <label for="code_filename_1">Code File Name 1 (e.g., app.py):</label>
                            <input type="text" id="code_filename_1" name="code_filename_1" placeholder="e.g., app.py" required />

                            <label for="code_content_1">Code Content 1:</label>
                            <textarea id="code_content_1" name="code_content_1" rows="15" placeholder="Paste your program source code here." required></textarea>
                            <hr style="margin: 20px 0; border-style: dashed;"/>
                        </div>
                    </div>

                    <button type="button" id="add_code_file_btn" style="background-color: #3f51b5; margin-bottom: 30px;">
                        âž• Add Another Code File
                    </button>

                    <input type="hidden" id="all_code_data" name="all_code_data" value="[]">

                    <h2 style="margin-top: 30px;">ðŸ–¼ User Interface Screenshots</h2>

                    <div id="screenshot_files_container">
                        <div class="screenshot-entry" data-index="1">
                            <label for="screenshot_name_1">Screenshot Name 1 (e.g., Onboarding Screen):</label>
                            <input type="text" id="screenshot_name_1" name="screenshot_name_1" placeholder="e.g., Dashboard View" required />

                            <label for="screenshot_file_1">Screenshot Image 1:</label>
                            <input type="file" id="screenshot_file_1" name="screenshot_file_1" accept="image/*" required />
                            <hr style="margin: 20px 0; border-style: dashed;"/>
                        </div>
                    </div>

                    <button type="button" id="add_screenshot_btn" style="background-color: #008080; margin-bottom: 30px;">
                        âž• Add Another Screenshot
                    </button>
                    <input type="hidden" id="all_screenshot_data" name="all_screenshot_data" value="[]">

                    <label for="plagarism_report">Plagiarism Report:</label>
                    <input type="file" id="plagarism_report" name="plagarism_report" accept="image/*" />

                    <div class="diagram-manager">
                        <h2>ðŸ“Š Project Diagrams Manager</h2>
                        <p style="font-size: 0.9em; color: #666; margin-top: -8px;">
                            For each diagram, either upload manually or generate using AI.
                        </p>

                        <div class="diagram-card" data-diagram-key="event_table">
                            <h4>A. Event Table</h4>
                            <div class="diagram-row">
                                <input type="file" id="event_table_diagram" name="event_table_diagram" accept="image/*" />
                                <button type="button" id="generate_ai_event_table">Generate with AI</button>
                            </div>
                            <input type="hidden" id="ai_event_table_filename" name="ai_event_table_filename" value="" />
                            <div id="diagram_status_event_table" class="diagram-status"></div>
                            <img id="diagram_preview_event_table" class="diagram-preview hidden" alt="Event Table preview" />
                        </div>

                        <div class="diagram-card" data-diagram-key="entity_relationship">
                            <h4>B. Entity Relationship Diagram</h4>
                            <div class="diagram-row">
                                <input type="file" id="er_diagram" name="er_diagram" accept="image/*" />
                                <button type="button" id="generate_ai_entity_relationship">Generate with AI</button>
                            </div>
                            <input type="hidden" id="ai_entity_relationship_filename" name="ai_entity_relationship_filename" value="" />
                            <div id="diagram_status_entity_relationship" class="diagram-status"></div>
                            <img id="diagram_preview_entity_relationship" class="diagram-preview hidden" alt="Entity Relationship Diagram preview" />
                        </div>

                        <div class="diagram-card" data-diagram-key="class">
                            <h4>C. Class Diagram</h4>
                            <div class="diagram-row">
                                <input type="file" id="class_diagram" name="class_diagram" accept="image/*" />
                                <button type="button" id="generate_ai_class">Generate with AI</button>
                            </div>
                            <input type="hidden" id="ai_class_filename" name="ai_class_filename" value="" />
                            <div id="diagram_status_class" class="diagram-status"></div>
                            <img id="diagram_preview_class" class="diagram-preview hidden" alt="Class Diagram preview" />
                        </div>

                        <div class="diagram-card" data-diagram-key="activity">
                            <h4>D. Activity Diagram</h4>
                            <div class="diagram-row">
                                <input type="file" id="activity_diagram" name="activity_diagram" accept="image/*" />
                                <button type="button" id="generate_ai_activity">Generate with AI</button>
                            </div>
                            <input type="hidden" id="ai_activity_filename" name="ai_activity_filename" value="" />
                            <div id="diagram_status_activity" class="diagram-status"></div>
                            <img id="diagram_preview_activity" class="diagram-preview hidden" alt="Activity Diagram preview" />
                        </div>

                        <div class="diagram-card" data-diagram-key="use_case">
                            <h4>E. Use Case Diagram</h4>
                            <div class="diagram-row">
                                <input type="file" id="usecase_diagram" name="usecase_diagram" accept="image/*" />
                                <button type="button" id="generate_ai_use_case">Generate with AI</button>
                            </div>
                            <input type="hidden" id="ai_use_case_filename" name="ai_use_case_filename" value="" />
                            <div id="diagram_status_use_case" class="diagram-status"></div>
                            <img id="diagram_preview_use_case" class="diagram-preview hidden" alt="Use Case Diagram preview" />
                        </div>

                        <div class="diagram-card" data-diagram-key="sequence">
                            <h4>F. Sequence Diagram</h4>
                            <div class="diagram-row">
                                <input type="file" id="sequence_diagram" name="sequence_diagram" accept="image/*" />
                                <button type="button" id="generate_ai_sequence">Generate with AI</button>
                            </div>
                            <input type="hidden" id="ai_sequence_filename" name="ai_sequence_filename" value="" />
                            <div id="diagram_status_sequence" class="diagram-status"></div>
                            <img id="diagram_preview_sequence" class="diagram-preview hidden" alt="Sequence Diagram preview" />
                        </div>

                        <div class="diagram-card" data-diagram-key="component">
                            <h4>G. Component Diagram</h4>
                            <div class="diagram-row">
                                <input type="file" id="component_diagram" name="component_diagram" accept="image/*" />
                                <button type="button" id="generate_ai_component">Generate with AI</button>
                            </div>
                            <input type="hidden" id="ai_component_filename" name="ai_component_filename" value="" />
                            <div id="diagram_status_component" class="diagram-status"></div>
                            <img id="diagram_preview_component" class="diagram-preview hidden" alt="Component Diagram preview" />
                        </div>

                        <div class="diagram-card" data-diagram-key="deployment">
                            <h4>H. Deployment Diagram</h4>
                            <div class="diagram-row">
                                <input type="file" id="deployment_diagram" name="deployment_diagram" accept="image/*" />
                                <button type="button" id="generate_ai_deployment">Generate with AI</button>
                            </div>
                            <input type="hidden" id="ai_deployment_filename" name="ai_deployment_filename" value="" />
                            <div id="diagram_status_deployment" class="diagram-status"></div>
                            <img id="diagram_preview_deployment" class="diagram-preview hidden" alt="Deployment Diagram preview" />
                        </div>

                        <div class="diagram-card" data-diagram-key="database">
                            <h4>I. Database Diagram</h4>
                            <div class="diagram-row">
                                <input type="file" id="database_model" name="database_model" accept="image/*" />
                                <button type="button" id="generate_ai_database">Generate with AI</button>
                            </div>
                            <input type="hidden" id="ai_database_filename" name="ai_database_filename" value="" />
                            <div id="diagram_status_database" class="diagram-status"></div>
                            <img id="diagram_preview_database" class="diagram-preview hidden" alt="Database Diagram preview" />
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button type="submit">Update Document & Upload Images</button>
                        <button type="button" id="toggle-preview-btn">
                            Hide Preview
                        </button>
                    </div>
                </form>
            </div>

            <div class="preview-section">
                <h2>Live Preview</h2>
                <div id="preview-content" class="preview-content">
                    Loading preview...
                </div>
            </div>
        </div>
    </div>
    <script>
        const mainForm = document.getElementById("mainForm");
        const previewSection = document.querySelector(".preview-section");
        const previewContent = document.getElementById("preview-content");
        const toggleBtn = document.getElementById("toggle-preview-btn");
        const templateSelector = document.getElementById("template_selector"); 
        const selectedTemplateFile = document.getElementById("selected_template_file"); 
        
        // Spans for displaying old details
        const oldNameSpan = document.getElementById("old_name_span");
        const oldProjectSpan = document.getElementById("old_project_span");
        const oldProfessorSpan = document.getElementById("old_professor_span");
        const oldGuideSpan = document.getElementById("old_guide_span");
        const oldYearSpan = document.getElementById("old_year_span");
        const currentFileSpan = document.getElementById("current_file_span");
        
        // Code implementation elements
        const codeFilesContainer = document.getElementById('code_files_container');
        const addCodeFileBtn = document.getElementById('add_code_file_btn');
        const allCodeDataInput = document.getElementById('all_code_data');
        let fileIndex = 1; // Tracks the current number of code files

        // Screenshot implementation elements
        const screenshotFilesContainer = document.getElementById('screenshot_files_container');
        const addScreenshotBtn = document.getElementById('add_screenshot_btn');
        const allScreenshotDataInput = document.getElementById('all_screenshot_data');
        let screenshotIndex = 1;

        // Documentation editor elements
        const docSectionSelector = document.getElementById('doc_section_selector');
        const contentEditor = document.getElementById('content_editor');
        const editorInfoParagraph = contentEditor.nextElementSibling;
        const generatedFilesDataInput = document.getElementById('generated_files_data');
        const oldProjectTitleSpan = document.getElementById('old_project_span');

        const diagramConfigs = [
            { key: "event_table", outputKey: "event_table", displayName: "Event Table", inputId: "event_table_diagram" },
            { key: "entity_relationship", outputKey: "er_diagram", displayName: "Entity Relationship Diagram", inputId: "er_diagram" },
            { key: "class", outputKey: "class_diagram", displayName: "Class Diagram", inputId: "class_diagram" },
            { key: "activity", outputKey: "activity_diagram", displayName: "Activity Diagram", inputId: "activity_diagram" },
            { key: "use_case", outputKey: "usecase_diagram", displayName: "Use Case Diagram", inputId: "usecase_diagram" },
            { key: "sequence", outputKey: "sequence_diagram", displayName: "Sequence Diagram", inputId: "sequence_diagram" },
            { key: "component", outputKey: "component_diagram", displayName: "Component Diagram", inputId: "component_diagram" },
            { key: "deployment", outputKey: "deployment_diagram", displayName: "Deployment Diagram", inputId: "deployment_diagram" },
            { key: "database", outputKey: "database_model", displayName: "Database Diagram", inputId: "database_model" }
        ];

        // State object to hold content for all documentation sections
        const docContentCache = {
            'doc_introduction': '',
            'doc_objective': '',
            'doc_scope': '',
            'doc_techstack': '',
            'doc_feasibility': '',
            'doc_system_features': '',
            'doc_modules': '',
            'doc_usecase': '',
            'doc_advantage': '',
            'doc_hardware_req': '',
            'doc_software_req': ''
        };

        // --- Data Collection Functions ---

        function collectCodeData() {
            const codeData = [];
            document.querySelectorAll('.code-entry').forEach(entry => {
                const index = entry.getAttribute('data-index');
                const filenameInput = document.getElementById(`code_filename_${index}`);
                const contentInput = document.getElementById(`code_content_${index}`);

                if (filenameInput && contentInput && filenameInput.value.trim() && contentInput.value.trim()) {
                    codeData.push({ filename: filenameInput.value, content: contentInput.value });
                }
            });
            allCodeDataInput.value = JSON.stringify(codeData);
            return codeData;
        }

        function collectScreenshotData() {
            const screenshotData = [];
            document.querySelectorAll('.screenshot-entry').forEach(entry => {
                const index = entry.getAttribute('data-index');
                const nameInput = document.getElementById(`screenshot_name_${index}`);
                const fileInput = document.getElementById(`screenshot_file_${index}`);
                
                // CRITICAL: We pass the input name attribute as file_id for Flask to access request.files
                if (nameInput && nameInput.value.trim() && fileInput) {
                        screenshotData.push({ 
                            name: nameInput.value, 
                            file_id: fileInput.name 
                        });
                }
            });
            allScreenshotDataInput.value = JSON.stringify(screenshotData);
            return screenshotData;
        }

        function updateGeneratedFilesData() {
            const generatedMap = {};
            diagramConfigs.forEach((config) => {
                const hiddenInput = document.getElementById(`ai_${config.key}_filename`);
                if (hiddenInput && hiddenInput.value) {
                    generatedMap[config.outputKey || config.key] = hiddenInput.value;
                }
            });
            generatedFilesDataInput.value = JSON.stringify(generatedMap);
        }

        async function attachGeneratedImageToInput(fileInput, filename) {
            const response = await fetch(`/uploads/${encodeURIComponent(filename)}`);
            if (!response.ok) {
                throw new Error("Generated image could not be loaded for attachment.");
            }

            const blob = await response.blob();
            const generatedFile = new File([blob], filename, { type: blob.type || "image/png" });
            const transfer = new DataTransfer();
            transfer.items.add(generatedFile);

            // Mark this change as AI-driven so manual override logic is not triggered.
            fileInput.dataset.aiAssigned = "1";
            fileInput.files = transfer.files;
        }

        function setupDiagramManager() {
            diagramConfigs.forEach((config) => {
                const fileInput = document.getElementById(config.inputId);
                const generateBtn = document.getElementById(`generate_ai_${config.key}`);
                const hiddenInput = document.getElementById(`ai_${config.key}_filename`);
                const statusEl = document.getElementById(`diagram_status_${config.key}`);
                const previewImg = document.getElementById(`diagram_preview_${config.key}`);

                if (!fileInput || !generateBtn || !hiddenInput || !statusEl || !previewImg) {
                    return;
                }

                fileInput.addEventListener("change", () => {
                    const selectedFile = fileInput.files && fileInput.files[0];
                    if (!selectedFile) {
                        return;
                    }

                    // Manual selection always overrides AI-generated reference.
                    if (fileInput.dataset.aiAssigned === "1") {
                        fileInput.dataset.aiAssigned = "0";
                    } else {
                        hiddenInput.value = "";
                        statusEl.innerHTML = '<span style="color: #2e7d32;">Manual upload selected. AI version overridden.</span>';
                    }

                    previewImg.src = URL.createObjectURL(selectedFile);
                    previewImg.classList.remove("hidden");
                    updateGeneratedFilesData();
                    updatePreview();
                });

                generateBtn.addEventListener("click", async () => {
                    const enteredProjectTitle = document.getElementById("project_title").value.trim();
                    const projectTitle = enteredProjectTitle || oldProjectTitleSpan.textContent.trim();

                    if (!projectTitle) {
                        statusEl.innerHTML = '<span style="color: red;">Please enter a Project Title first.</span>';
                        return;
                    }

                    statusEl.innerHTML = '<span style="color: #1a73e8;"><span class="spinner"></span>Generating diagram...</span>';
                    generateBtn.disabled = true;

                    try {
                        const response = await fetch("/generate_diagrams", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                project_title: projectTitle,
                                diagram_type: config.displayName
                            })
                        });

                        const data = await response.json();
                        if (!response.ok || data.status !== "success") {
                            throw new Error(data.error || "Diagram generation failed.");
                        }

                        hiddenInput.value = data.filename;
                        previewImg.src = `/uploads/${encodeURIComponent(data.filename)}?t=${Date.now()}`;
                        previewImg.classList.remove("hidden");
                        statusEl.innerHTML = '<span style="color: #2e7d32;">Diagram generated successfully.</span>';

                        // Attach generated image into the file input so it submits with the form.
                        await attachGeneratedImageToInput(fileInput, data.filename);

                        updateGeneratedFilesData();
                        updatePreview();
                    } catch (error) {
                        statusEl.innerHTML = `<span style="color: red;">${error.message}</span>`;
                    } finally {
                        generateBtn.disabled = false;
                    }
                });
            });
        }


        // --- Dynamic Entry Functions ---

        function addCodeEntry() {
            fileIndex++;
            const newEntry = document.createElement('div');
            newEntry.className = 'code-entry';
            newEntry.setAttribute('data-index', fileIndex);
            
            newEntry.innerHTML = `
                <label for="code_filename_${fileIndex}">Code File Name ${fileIndex}:</label>
                <input type="text" id="code_filename_${fileIndex}" name="code_filename_${fileIndex}" placeholder="e.g., models.py" required />

                <label for="code_content_${fileIndex}">Code Content ${fileIndex}:</label>
                <textarea id="code_content_${fileIndex}" name="code_content_${fileIndex}" rows="15" placeholder="Paste your program source code here." required></textarea>
                
                <button type="button" class="remove-code-btn" data-target="${fileIndex}" style="background-color: #dc3545; width: 150px; float: right; margin-bottom: 15px;">
                    Remove File
                </button>
                <hr style="clear: both; margin: 20px 0; border-style: dashed;"/>
            `;
            
            codeFilesContainer.appendChild(newEntry);
            
            const filenameInput = newEntry.querySelector(`#code_filename_${fileIndex}`);
            const contentInput = newEntry.querySelector(`#code_content_${fileIndex}`);

            filenameInput.addEventListener('input', updatePreview);
            contentInput.addEventListener('input', updatePreview);
            
            updatePreview();
        }
        
        function addScreenshotEntry() {
            screenshotIndex++;
            const newEntry = document.createElement('div');
            newEntry.className = 'screenshot-entry';
            newEntry.setAttribute('data-index', screenshotIndex);
            
            newEntry.innerHTML = `
                <label for="screenshot_name_${screenshotIndex}">Screenshot Name ${screenshotIndex}:</label>
                <input type="text" id="screenshot_name_${screenshotIndex}" name="screenshot_name_${screenshotIndex}" placeholder="e.g., Settings Page" required />

                <label for="screenshot_file_${screenshotIndex}">Screenshot Image ${screenshotIndex}:</label>
                <input type="file" id="screenshot_file_${screenshotIndex}" name="screenshot_file_${screenshotIndex}" accept="image/*" required />
                
                <button type="button" class="remove-screenshot-btn" data-target="${screenshotIndex}" style="background-color: #dc3545; width: 150px; float: right; margin-bottom: 15px;">
                    Remove File
                </button>
                <hr style="clear: both; margin: 20px 0; border-style: dashed;"/>
            `;
            
            screenshotFilesContainer.appendChild(newEntry);
            
            const nameInput = newEntry.querySelector(`#screenshot_name_${screenshotIndex}`);
            const fileInput = newEntry.querySelector(`#screenshot_file_${screenshotIndex}`);

            nameInput.addEventListener('input', updatePreview);
            fileInput.addEventListener('change', updatePreview);
            
            updatePreview();
        }

        addCodeFileBtn.addEventListener('click', addCodeEntry);
        addScreenshotBtn.addEventListener('click', addScreenshotEntry);

        // Remove button listener (uses event delegation for code and screenshots)
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-code-btn') || e.target.classList.contains('remove-screenshot-btn')) {
                e.target.closest('.code-entry, .screenshot-entry').remove();
                updatePreview();
            }
        });
        
        // Initial setup for the first entry (Attach listener to initial file/code fields)
        document.getElementById('code_filename_1').addEventListener('input', updatePreview);
        document.getElementById('code_content_1').addEventListener('input', updatePreview);
        document.getElementById('screenshot_name_1').addEventListener('input', updatePreview);
        document.getElementById('screenshot_file_1').addEventListener('change', updatePreview);


        // --- Core Preview Logic (Remains the same) ---

        async function updatePreview() {
            collectCodeData();
            collectScreenshotData(); 

            docContentCache[contentEditor.name] = contentEditor.value;

            const data = getAllFormData();

            try {
                const response = await fetch("/preview", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                });
                const result = await response.json();

                if (response.ok) {
                    previewContent.innerHTML = result.html;
                } else {
                    previewContent.innerText = "Error loading preview: " + result.error;
                }
            } catch (error) {
                previewContent.innerText =
                    "Network error: Unable to connect to server.";
            }
        }

        function getAllFormData() {
            const formData = new FormData(mainForm);
            const data = Object.fromEntries(formData.entries());

            Object.assign(data, docContentCache);

            return data;
        }

        // Function to update the template details display (Remains the same)
        function updateDetailsDisplay(selectedOption) {
            const detailsJson = selectedOption.getAttribute("data-details");
            const details = JSON.parse(detailsJson);

            oldNameSpan.textContent = details.student_name;
            oldProjectSpan.textContent = details.project_title;
            oldProfessorSpan.textContent = details.professor_name;
            oldGuideSpan.textContent = details.guide_name;
            oldYearSpan.textContent = details.year;
            currentFileSpan.textContent = selectedOption.value;

            selectedTemplateFile.value = selectedOption.value;

            for (const key in docContentCache) {
                docContentCache[key] = '';
            }
            contentEditor.value = '';
            contentEditor.name = 'doc_introduction'; 
            docSectionSelector.value = 'doc_introduction'; 
            editorInfoParagraph.textContent = `This text will replace the tag [[doc_introduction]] in the template.`;

            updatePreview();
        }

        // Event listener for template selection change (Remains the same)
        templateSelector.addEventListener("change", (e) => {
            const selectedOption = e.target.options[e.target.selectedIndex];
            updateDetailsDisplay(selectedOption);
        });

        // 1. Load content from cache when section selector changes (Remains the same)
        docSectionSelector.addEventListener('change', (e) => {
            const newTag = e.target.value;
            const currentTag = contentEditor.name;
            
            docContentCache[currentTag] = contentEditor.value;
            
            contentEditor.value = docContentCache[newTag];
            
            contentEditor.name = newTag; 
            
            editorInfoParagraph.textContent = `This text will replace the tag [[${newTag}]] in the template.`;
            updatePreview();
        });

        // Toggle button functionality (Remains the same)
        toggleBtn.addEventListener("click", () => {
            previewSection.classList.toggle("hidden");
            if (previewSection.classList.contains("hidden")) {
                toggleBtn.innerText = "Show Preview";
            } else {
                toggleBtn.innerText = "Hide Preview";
            }
        });
        
        // --- CRITICAL FIX: Intercept final form submission to include all cached data ---
        mainForm.addEventListener('submit', function (event) {
            // 1. Final collect of all code and documentation data before submission
            collectCodeData();
            collectScreenshotData();
            docContentCache[contentEditor.name] = contentEditor.value; // Final save of documentation content
            updateGeneratedFilesData();
            
            // 2. Create hidden inputs for ALL cached documentation content
            for (const tag in docContentCache) {
                let input = mainForm.elements.namedItem(tag);
                if (!input) {
                    input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = tag;
                    mainForm.appendChild(input);
                }
                input.value = docContentCache[tag];
            }
            // The browser will handle the final POST
        });
        
        // Initial setup: ensure the displayed details match the default option
        const initialOption = templateSelector.options[templateSelector.selectedIndex];
        if (initialOption) {
            updateDetailsDisplay(initialOption);
        }

        setupDiagramManager();

        // Add event listeners to all standard text input fields for live preview
        const textInputs = mainForm.querySelectorAll('input[type="text"]');
        textInputs.forEach((input) => {
            input.addEventListener("input", updatePreview);
        });
    </script>
    
    <script>
    document.getElementById('generate-doc-btn').addEventListener('click', function() {

        // 1. Get the project title (This will now correctly find the one at the top)
        const projectTitle = document.getElementById('project_title').value;
        const statusEl = document.getElementById('ai-status');

        if (!projectTitle) {
            statusEl.innerHTML = '<span style="color: red;">Please enter a Project Title first.</span>';
            return;
        }

        // 2. Show a loading message
        statusEl.innerHTML = '<span style="color: blue;">Generating AI content... (This may take a moment)</span>';
        this.disabled = true; // Disable button during request

        // 3. Call the new Flask route
        fetch('/generate_project_content', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ project_title: projectTitle })
        })
        .then(response => {
            if (!response.ok) {
                // This will catch the 500 error until you fix the API key
                return response.json().then(err => { throw new Error(err.error); });
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }

            // 4. --- THIS IS THE CORRECTED LOGIC ---
            // This list must match the DOCUMENTATION_TAGS in app.py
            const tags = [
                'doc_introduction', 'doc_objective', 'doc_scope', 'doc_techstack',
                'doc_feasibility', 'doc_system_features', 'doc_modules', 'doc_usecase',
                'doc_advantage', 'doc_hardware_req', 'doc_software_req'
            ];

            let fieldsFilled = 0;
            tags.forEach(tag => {
                if (data[tag]) {
                    // Put the AI data directly into your JavaScript cache object
                    docContentCache[tag] = data[tag]; 
                    fieldsFilled++;
                }
            });

            // Now, update the visible form to show the first piece of content
            const firstTag = tags[0]; // 'doc_introduction'
            if (docContentCache[firstTag]) {
                docSectionSelector.value = firstTag;
                contentEditor.value = docContentCache[firstTag];
                contentEditor.name = firstTag;
                editorInfoParagraph.textContent = `This text will replace the tag [[${firstTag}]] in the template.`;
            }
            
            // Trigger a preview update
            updatePreview();
            
            statusEl.innerHTML = `<span style="color: green;">Success! Filled ${fieldsFilled} fields. Please review the content.</span>`;
            
        })
        .catch(error => {
            console.error('AI Generation Error:', error);
            statusEl.innerHTML = `<span style="color: red;">Error: ${error.message}</span>`;
        })
        .finally(() => {
            this.disabled = false; // Re-enable the button
        });
    });
    </script>
</body>

</html>
